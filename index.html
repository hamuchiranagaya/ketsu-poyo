<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆ</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4facfe">
  <link rel="icon" href="ketsupoyo.png" type="image/png">
  
  <style>
    :root{--bg:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);--panel:#2a3f5f;--fg:#fff;--muted:#b8c6db;--btn:#34495e;--accent:#f39c12;--card-bg:#34495e;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Hiragino Sans',sans-serif;min-height:100vh}
    body{background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)}
    #wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding:12px 8px}
    header{display:flex;align-items:center;gap:10px}
    header img{width:40px;height:40px;border-radius:8px;display:none}
    header.ready img{display:block}
    h1, h2{margin:0;font-size:20px;font-weight:800;text-align:center;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    h1{font-size:32px;color:#fff}
    canvas{background:var(--panel);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .hud{display:flex;gap:14px;align-items:center;justify-content:center;flex-wrap:wrap}
    .hud .muted{color:var(--muted)}
    .btnbar{display:flex;justify-content:space-between;gap:4px;width:100%;touch-action:manipulation;flex-wrap:wrap}
    .btnbar > button{flex:1;max-width:19%;height:60px;border:none;border-radius:12px;background:var(--btn);color:var(--fg);font-weight:700;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .btnbar > button:active{transform:translateY(1px);opacity:.9}
    .btnbar > .wide{flex:1 1 100%;max-width:100%;margin-top:8px}
    .note{opacity:.85;font-size:12px;text-align:center;line-height:1.4;max-width:620px;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,0.3)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .pill{background:rgba(255,255,255,0.2);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;border:none;color:var(--fg);backdrop-filter:blur(10px)}
    .pill:hover{background:rgba(255,255,255,0.3)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;backdrop-filter:blur(5px)}
    .card{background:linear-gradient(135deg, #ff6b6b, #ffa500, #ff69b4, #9c88ff);border:3px solid rgba(255,255,255,0.9);border-radius:24px;max-width:520px;width:96%;padding:24px;box-shadow:0 20px 40px rgba(0,0,0,.5), 0 0 20px rgba(255,255,255,0.2);position:relative;overflow:hidden;animation:cardPop 0.5s ease-out}
    @keyframes cardPop{0%{transform:scale(0.5) rotate(-5deg);opacity:0}50%{transform:scale(1.1) rotate(2deg)}100%{transform:scale(1) rotate(0deg);opacity:1}}
    .card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg, transparent, rgba(255,255,255,0.15), transparent);animation:shimmer 2s infinite;pointer-events:none}
    @keyframes shimmer{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}100%{transform:translateX(100%) translateY(100%) rotate(45deg)}}
    .card h3{margin:8px 0 16px 0;font-size:32px;color:#fff;text-shadow:3px 3px 6px rgba(0,0,0,0.6);text-align:center;font-weight:bold;animation:titleBounce 0.8s ease-out 0.2s both}
    @keyframes titleBounce{0%{transform:translateY(-20px);opacity:0}60%{transform:translateY(5px)}100%{transform:translateY(0);opacity:1}}
    .card p{color:#fff;font-size:18px;text-shadow:2px 2px 4px rgba(0,0,0,0.6);text-align:center;margin:16px 0;animation:fadeInUp 0.6s ease-out 0.4s both}
    @keyframes fadeInUp{0%{transform:translateY(20px);opacity:0}100%{transform:translateY(0);opacity:1}}
    .row{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;animation:fadeInUp 0.6s ease-out 0.6s both}
    .row button{background:linear-gradient(135deg, #4facfe, #00f2fe);border:3px solid rgba(255,255,255,0.9);border-radius:20px;padding:14px 24px;color:#fff;font-weight:700;cursor:pointer;font-size:16px;text-shadow:1px 1px 2px rgba(0,0,0,0.4);transition:all 0.3s;box-shadow:0 6px 15px rgba(0,0,0,0.3);position:relative;overflow:hidden}
    .row button::before{content:'';position:absolute;inset:0;background:linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);transform:translateX(-100%);transition:transform 0.6s}
    .row button:hover::before{transform:translateX(100%)}
    .row button:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 10px 25px rgba(0,0,0,0.4);background:linear-gradient(135deg, #00f2fe, #4facfe)}
    .row button:active{transform:translateY(-1px) scale(1.02)}
    .scores{display:flex;gap:16px;margin:24px 0;justify-content:center;flex-wrap:wrap;animation:fadeInUp 0.6s ease-out 0.5s both}
    .scores span{background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.8));color:#333;border-radius:16px;padding:10px 16px;font-weight:700;font-size:18px;box-shadow:0 4px 12px rgba(0,0,0,0.3);border:2px solid rgba(255,255,255,0.9);animation:scoreGlow 2s ease-in-out infinite alternate}
    @keyframes scoreGlow{0%{box-shadow:0 4px 12px rgba(0,0,0,0.3)}100%{box-shadow:0 4px 12px rgba(255,255,255,0.4), 0 0 20px rgba(255,255,255,0.2)}}
    
    /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
    .start-screen{text-align:center;padding:20px;background:rgba(255,255,255,0.1);border-radius:20px;margin:20px;backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,0.2)}
    .start-screen h1{font-size:32px;margin:20px 0;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    .app-icon{width:80px;height:80px;border-radius:16px;margin:0 auto 20px auto;display:none;box-shadow:0 4px 16px rgba(0,0,0,0.3)}
    .app-icon.ready{display:block}
    .game-description{font-size:14px;margin:20px 0;color:#fff;line-height:1.6;text-shadow:1px 1px 2px rgba(0,0,0,0.3)}
    .start-btn{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;border:none;border-radius:16px;padding:16px 32px;font-size:18px;font-weight:bold;cursor:pointer;box-shadow:0 8px 24px rgba(243,156,18,.3);margin:20px 0;text-shadow:1px 1px 2px rgba(0,0,0,0.3)}
    .start-btn:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(243,156,18,.4)}
    .install-section{margin:20px 0;padding:16px;background:rgba(255,255,255,0.1);border-radius:12px;backdrop-filter:blur(10px)}
    .install-btn{background:rgba(255,255,255,0.2);border:2px dashed rgba(255,255,255,0.4);border-radius:12px;padding:12px 20px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;margin:8px 0;color:#fff;backdrop-filter:blur(10px)}
    .install-btn:hover{background:rgba(255,255,255,0.3);border-color:rgba(255,255,255,0.6)}
    .youtube-link{display:block;margin:16px auto;color:var(--accent);font-weight:600;text-shadow:1px 1px 2px rgba(0,0,0,0.3);text-align:center}
    .youtube-link:hover{color:#fff;text-decoration:underline}
    .share-buttons{display:flex;gap:12px;justify-content:center;margin:16px 0}
    .share-btn{background:rgba(255,255,255,0.2);border:none;border-radius:12px;padding:10px 16px;color:#fff;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;backdrop-filter:blur(10px)}
    .share-btn:hover{background:rgba(255,255,255,0.3)}
    .share-btn.x-btn{background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2)}
    .share-btn.x-btn:hover{background:rgba(0,0,0,0.5)}
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ */
    .stage-selection{margin:20px 0}
    .stage-selection h3{color:#fff;margin-bottom:16px;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    .stage-buttons{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;max-width:400px;margin:0 auto}
    .stage-btn{background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:12px;padding:12px 8px;cursor:pointer;color:#fff;display:flex;flex-direction:column;align-items:center;gap:4px;backdrop-filter:blur(10px);transition:all 0.3s}
    .stage-btn:hover{background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.4)}
    .stage-btn.active{background:linear-gradient(135deg,#f39c12,#e67e22);border-color:#f39c12;box-shadow:0 4px 12px rgba(243,156,18,.3)}
    .stage-icon{font-size:24px}
    .stage-name{font-weight:bold;font-size:14px}
    .game-area{display:none}
    .game-area.active{display:flex;flex-direction:column;align-items:center;gap:10px}
    
    /* å›³é‘‘ç”»é¢ */
    .pokedex-card{max-width: 600px; max-height: 80vh; overflow-y: auto;}
    .pokedex-grid{display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0;}
    .pokedex-entry{border-radius: 12px; padding: 12px; text-align: center; color: white; font-size: 12px; border: 2px solid; transition: all 0.3s; position: relative;}
    .pokedex-entry.discovered{background: linear-gradient(135deg, #4facfe, #00f2fe); border-color: rgba(255,255,255,0.8);}
    .pokedex-entry.discovered:hover{transform: translateY(-2px) scale(1.02); box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);}
    .pokedex-entry.undiscovered{background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3);}
    .pokedex-image{transition: transform 0.3s;}
    .pokedex-entry.discovered:hover .pokedex-image{transform: scale(1.1);}
    
    /* è©³ç´°ç”»é¢ã®ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    .detail-btn{transition: all 0.3s; position: relative; overflow: hidden;}
    .detail-btn::before{content: ''; position: absolute; inset: 0; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent); transform: translateX(-100%); transition: transform 0.6s;}
    .detail-btn:hover::before{transform: translateX(100%);}
    .detail-btn:hover{transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.3);}
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 480px) {
      .pokedex-grid{grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;}
      .pokedex-entry{padding: 8px; font-size: 11px;}
    }
  </style>
</head>
<body>
<div id="wrap">
  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <div id="startScreen" class="start-screen">
    <img id="appicon" alt="ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³" class="app-icon"/>
    <h1>ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆ</h1>
    
    <div class="install-section">
      <p>ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ä½¿ãˆã¾ã™</p>
      <button id="installBtn" class="install-btn" style="display: inline-flex;" onclick="simpleInstall()">
        <span>ğŸ“²</span>
        <span id="installText">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </span>
      </button>
    </div>
    
    <div class="game-description">
      4å€‹ä»¥ä¸Šã®åŒã˜è‰²ã®ã¯ã‚€ã‚±ãƒ„ã‚’ã¤ãªã’ã¦æ¶ˆãã†ï¼<br/>
      é€£é–ã§ã‚¹ã‚³ã‚¢ã‚¢ãƒƒãƒ—ï¼
    </div>
    
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ -->
    <div class="stage-selection">
      <h3>ğŸŒ¸ ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é¸ã‚“ã§ã­ ğŸŒ¸</h3>
      <div class="stage-buttons">
        <button class="stage-btn active" onclick="selectStage(0)">
          <span class="stage-icon">ğŸŒ¸</span>
          <span class="stage-name">æ˜¥ã®ã‚±ãƒ„</span>
        </button>
        <button class="stage-btn" onclick="selectStage(1)">
          <span class="stage-icon">ğŸŒ»</span>
          <span class="stage-name">å¤ã®ã‚±ãƒ„</span>
        </button>
        <button class="stage-btn" onclick="selectStage(2)">
          <span class="stage-icon">ğŸ‚</span>
          <span class="stage-name">ç§‹ã®ã‚±ãƒ„</span>
        </button>
        <button class="stage-btn" onclick="selectStage(3)">
          <span class="stage-icon">â„ï¸</span>
          <span class="stage-name">å†¬ã®ã‚±ãƒ„</span>
        </button>
      </div>
    </div>
    
    <button class="start-btn" onclick="startGame();">
      ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
    </button>
    
    <!-- å›³é‘‘ãƒœã‚¿ãƒ³ -->
    <button class="start-btn" onclick="showPokedex()" style="font-size: 16px; padding: 12px 24px; margin: 10px 0; background: linear-gradient(135deg, #9c88ff, #6c5ce7);">
      ğŸ“– å›³é‘‘ã‚’è¦‹ã‚‹ (<span id="pokedexCount">0/24</span>)
    </button>
    
    <!-- ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ -->
    <button class="start-btn" onclick="showMyPage()" style="font-size: 16px; padding: 12px 24px; margin: 10px 0; background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">
      ğŸ“„ ãƒã‚¤ãƒšãƒ¼ã‚¸
    </button>
    
    <a href="https://youtube.com/@hamuchira" target="_blank" class="youtube-link">
      ğŸ¬ ã‚‚ã£ã¨ï¼ã¯ã‚€ãƒãƒ©é•·å±‹ch.
    </a>
    
    <div class="share-buttons">
      <button class="share-btn x-btn" onclick="shareToX()">
        Xã§ã‚·ã‚§ã‚¢
      </button>
      <button class="share-btn" onclick="copyURL()">
        <span>ğŸ“‹</span>
        <span id="copyText">URLã‚³ãƒ”ãƒ¼</span>
      </button>
    </div>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
  <div id="gameArea" class="game-area">
    <header>
      <h2>ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆ</h2>
    </header>

    <div class="hud">
      <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
      <div>ãƒã‚§ã‚¤ãƒ³: <span id="chain">0</span></div>
      <div id="timeWrap" class="muted" style="display:none;">æ®‹ã‚Š: <span id="time">180</span>s</div>
      <button id="mode" class="pill" title="åˆ¶é™æ™‚é–“ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿" onclick="toggleTimeMode()">åˆ¶é™æ™‚é–“:OFF</button>
    </div>

    <canvas id="game" width="384" height="640"></canvas>

    <div class="btnbar" aria-label="ã‚¿ãƒƒãƒ—æ“ä½œ">
      <button onclick="rotate()">â†º</button>
      <button onclick="moveLeft()">â†</button>
      <button onclick="softDrop()">â†“</button>
      <button onclick="moveRight()">â†’</button>
      <button onclick="rotate()">â†»</button>
      <button class="wide" onclick="hardDrop()">ç¬é–“è½ä¸‹</button>
    </div>

    <div class="note">
      æ“ä½œï¼šâ† â†’ ç§»å‹• / â†‘ å›è»¢ / â†“ ã‚½ãƒ•ãƒˆãƒ‰ãƒ­ãƒƒãƒ— / ã‚¹ãƒšãƒ¼ã‚¹ ç¬é–“è½ä¸‹ / R ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
    </div>
  </div>
</div>

<!-- å›³é‘‘ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="pokedexScreen" class="overlay">
  <div class="card pokedex-card">
    <h3>ğŸ“– ã¯ã‚€ã‚±ãƒ„å›³é‘‘ ğŸ“–</h3>
    <p>ã¯ã‚€ã‚±ãƒ„ã‚’30å€‹æ¶ˆã™ã¨å›³é‘‘ã«ç™»éŒ²ã•ã‚Œã¾ã™ï¼</p>
    
    <div id="pokedexGrid" class="pokedex-grid">
      <!-- å›³é‘‘ã‚¨ãƒ³ãƒˆãƒªãŒã“ã“ã«å‹•çš„ç”Ÿæˆã•ã‚Œã‚‹ -->
    </div>
    
    <div class="row" style="margin-top: 20px;">
      <button onclick="closePokedex()" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ»ã‚¯ãƒªã‚¢ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="gameOverlay" class="overlay">
  <div class="card" role="dialog" aria-modal="true">
    <h3 id="ovTitle">çµæœ</h3>
    <p id="ovMsg"></p>
    <div class="scores">ãƒ™ã‚¹ãƒˆ: <span id="best1">-</span><span id="best2">-</span><span id="best3">-</span></div>
    <div class="row" style="margin-top:10px">
      <button onclick="restart()">ãƒªãƒˆãƒ©ã‚¤</button>
      <button onclick="backToStart()">è«¦ã‚ã‚‹</button>
      <button onclick="shareResult()">çµæœã‚’Xã§ã‚·ã‚§ã‚¢</button>
    </div>
  </div>
</div>

<script>
// ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
var BROWSER_BACK = {
  currentScreen: 'start', // start, game, pokedex, mypage, titlelist, iconselect
  initialized: false,
  
  init: function() {
    if (this.initialized) return;
    this.initialized = true;
    
    // åˆæœŸçŠ¶æ…‹ã‚’pushState
    history.replaceState({ screen: 'start' }, '', '');
    
    // popstateã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('popstate', this.handlePopState.bind(this));
  },
  
  pushState: function(screen) {
    this.currentScreen = screen;
    history.pushState({ screen: screen }, '', '');
  },
  
  handlePopState: function(event) {
    var targetScreen = event.state ? event.state.screen : 'start';
    
    // ç¾åœ¨ã®ç”»é¢ã‹ã‚‰é©åˆ‡ãªæˆ»ã‚Šå…ˆã«ç§»å‹•
    switch (this.currentScreen) {
      case 'game':
      case 'pokedex':
      case 'mypage':
        this.goToStart();
        break;
      case 'titlelist':
      case 'iconselect':
        this.goToMyPage();
        break;
      default:
        this.goToStart();
        break;
    }
  },
  
  goToStart: function() {
    // ã‚²ãƒ¼ãƒ ç”»é¢ã‚’é–‰ã˜ã‚‹
    if (gameStarted) {
      gameStarted = false;
      var gameArea = document.getElementById('gameArea');
      var startScreen = document.getElementById('startScreen');
      if (gameArea) gameArea.classList.remove('active');
      if (startScreen) startScreen.style.display = 'block';
    }
    
    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã‚‹
    this.closeAllOverlays();
    
    this.currentScreen = 'start';
  },
  
  goToMyPage: function() {
    // å‹•çš„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã‚‹
    this.closeDynamicOverlays();
    
    // ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
    this.currentScreen = 'mypage';
    showMyPage();
  },
  
  closeAllOverlays: function() {
    // å›³é‘‘ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    var pokedexScreen = document.getElementById('pokedexScreen');
    if (pokedexScreen) pokedexScreen.style.display = 'none';
    
    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    var gameOverlay = document.getElementById('gameOverlay');
    if (gameOverlay) gameOverlay.style.display = 'none';
    
    // å‹•çš„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    this.closeDynamicOverlays();
  },
  
  closeDynamicOverlays: function() {
    var dynamicOverlays = document.querySelectorAll('.overlay:not(#pokedexScreen):not(#gameOverlay)');
    dynamicOverlays.forEach(function(overlay) { overlay.remove(); });
  }
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
var currentStage = 0;
var gameStarted = false;
var grid;
var falling;
var nextPair;
var score = 0;
var chain = 0;
var gameOver = false;
var timeMode = false;
var timeLeft = 180000;
var dropTimer = 0;
var resolving = false;
var phase = 0;
var phaseTimer = 0;
var particles = [];

// ã‚²ãƒ¼ãƒ è¨­å®š
var canvas = null;
var ctx = null;
var W = 384;
var H = 640;
var COLS = 6;
var ROWS = 12;
var TILE = 0;
var PX = 0;
var PY = 0;
var TYPES = 6;
var COLORS = ['#f5c6a5', '#e0f0ff', '#c6d0ff', '#ffd9d9', '#c0ffc8', '#ffe6a8'];

// ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®š
var STAGES = [
  { name: 'æ˜¥ã®ã‚±ãƒ„', icon: 'ğŸŒ¸', range: [1, 6], season: 'spring' },
  { name: 'å¤ã®ã‚±ãƒ„', icon: 'ğŸŒ»', range: [7, 12], season: 'summer' },
  { name: 'ç§‹ã®ã‚±ãƒ„', icon: 'ğŸ‚', range: [13, 18], season: 'autumn' },
  { name: 'å†¬ã®ã‚±ãƒ„', icon: 'â„ï¸', range: [19, 24], season: 'winter' }
];

// ç”»åƒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä¿®æ­£ç‰ˆï¼‰
var IMAGE_MANAGER = {
  images: {},
  stageImages: {},
  currentStage: -1,
  loadedStages: new Set(),
  globalImageStatus: false,
  
  // å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç”»åƒã‚’ä¸€åº¦ã«èª­ã¿è¾¼ã‚€
  loadAllStageImages: function() {
    console.log('å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ç”»åƒèª­ã¿è¾¼ã¿é–‹å§‹');
    for (var i = 0; i < STAGES.length; i++) {
      this.loadStageImages(i);
    }
  },
  
  loadStageImages: function(stageIndex) {
    console.log('ç”»åƒèª­ã¿è¾¼ã¿é–‹å§‹: ã‚¹ãƒ†ãƒ¼ã‚¸', stageIndex);
    var stage = STAGES[stageIndex];
    var stageKey = 'stage_' + stageIndex;
    
    if (this.loadedStages.has(stageIndex)) {
      this.currentStage = stageIndex;
      this.updateGlobalStatus();
      return Promise.resolve();
    }
    
    this.currentStage = stageIndex;
    this.stageImages[stageKey] = [];
    
    var promises = [];
    
    for (var i = 0; i < TYPES; i++) {
      var imageNumber = stage.range[0] + i;
      var imagePath = 'assets/ham_' + String(imageNumber).padStart(2, '0') + '.png';
      
      var promise = new Promise((function(imgIndex, imageSrc) {
        return function(resolve, reject) {
          var img = new Image();
          img.onload = function() {
            IMAGE_MANAGER.stageImages[stageKey][imgIndex] = img;
            IMAGE_MANAGER.globalImageStatus = true;
            resolve(img);
          };
          img.onerror = function() {
            IMAGE_MANAGER.stageImages[stageKey][imgIndex] = null;
            resolve(null);
          };
          img.src = imageSrc;
        };
      })(i, imagePath));
      
      promises.push(promise);
    }
    
    return Promise.all(promises).then(() => {
      this.loadedStages.add(stageIndex);
      this.updateGlobalStatus();
    });
  },
  
  updateGlobalStatus: function() {
    useImages = this.globalImageStatus;
    hamImages = this.getCurrentStageImages();
  },
  
  getCurrentStageImages: function() {
    var stageKey = 'stage_' + this.currentStage;
    return this.stageImages[stageKey] || [];
  },
  
  // æŒ‡å®šã•ã‚ŒãŸIDã®ç”»åƒã‚’å–å¾—ï¼ˆã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ï¼‰
  getImageById: function(id) {
    var stageIndex = Math.floor((id - 1) / 6);
    var typeIndex = (id - 1) % 6;
    var stageKey = 'stage_' + stageIndex;
    
    if (this.stageImages[stageKey] && this.stageImages[stageKey][typeIndex]) {
      var img = this.stageImages[stageKey][typeIndex];
      if (img && img.complete && img.naturalWidth > 0) {
        return img;
      }
    }
    return null;
  },
  
  getSafeImage: function(typeIndex) {
    var currentImages = this.getCurrentStageImages();
    if (!currentImages || currentImages.length <= typeIndex) {
      return null;
    }
    var img = currentImages[typeIndex];
    if (img && img.complete && img.naturalWidth > 0) {
      return img;
    }
    return null;
  },
  
  isImageAvailable: function(typeIndex) {
    return this.getSafeImage(typeIndex) !== null;
  }
};

var hamImages = [];
var useImages = false;

// ç§°å·ãƒ»å›³é‘‘ãƒ‡ãƒ¼ã‚¿
var TITLE_DATA = {
  1: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ“ã‚®ãƒŠãƒ¼", condition_type: "default", condition_value: 0, description: "ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ãŸè¨¼", secret: false },
  2: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ‡ãƒ“ãƒ¥ãƒ¼", condition_type: "score_over", condition_value: 1000, description: "ã‚¹ã‚³ã‚¢1000ç‚¹ã‚’é”æˆã›ã‚ˆ", secret: false },
  3: { title: "ã¯ã‚€ã‚±ãƒ„è·äºº", condition_type: "score_over", condition_value: 5000, description: "ã‚¹ã‚³ã‚¢5000ç‚¹ã‚’é”æˆã›ã‚ˆ", secret: false },
  4: { title: "ã¯ã‚€ã‚±ãƒ„ã®åŒ ", condition_type: "score_over", condition_value: 10000, description: "ã‚¹ã‚³ã‚¢10000ç‚¹ã‚’é”æˆã›ã‚ˆ", secret: false },
  5: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰", condition_type: "score_over", condition_value: 15000, description: "ã‚¹ã‚³ã‚¢15000ç‚¹ã‚’é”æˆã›ã‚ˆ", secret: false },
  6: { title: "ã¯ã‚€ã‚±ãƒ„ã‚’æ¥µã‚ã—è€…", condition_type: "score_over", condition_value: 20000, description: "ã‚¹ã‚³ã‚¢20000ç‚¹ã‚’é”æˆã›ã‚ˆ", secret: false },
  7: { title: "ã¯ã‚€ã‚±ãƒ„æµæ˜Ÿç¾¤", condition_type: "chain", condition_value: 1, description: "1é€£é–ã‚’é”æˆã›ã‚ˆ", secret: false },
  8: { title: "ã¯ã‚€ã‚±ãƒ„éš•çŸ³è½ã¨ã—", condition_type: "chain", condition_value: 3, description: "3é€£é–ã‚’é”æˆã›ã‚ˆ", secret: false },
  9: { title: "ã¯ã‚€ã‚±ãƒ„ã‚¹ã‚¿ãƒ¼ãƒ¬ã‚¤ãƒ³", condition_type: "chain", condition_value: 5, description: "5é€£é–ã‚’é”æˆã›ã‚ˆ", secret: false },
  10: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ¡ãƒ†ã‚ª", condition_type: "chain", condition_value: 7, description: "7é€£é–ã‚’é”æˆã›ã‚ˆ", secret: false },
  11: { title: "ã¯ã‚€ã‚±ãƒ„ã‚®ãƒ£ãƒ©ã‚¯ã‚·ãƒ¼", condition_type: "chain", condition_value: 10, description: "10é€£é–ã‚’é”æˆã›ã‚ˆ", secret: false },
  12: { title: "ã¯ã‚€ã‚±ãƒ„ã‚³ã‚¹ãƒ¢", condition_type: "chain", condition_value: 15, description: "15é€£é–ã‚’é”æˆã›ã‚ˆ", secret: false },
  13: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ¦ãƒ‹ãƒãƒ¼ã‚¹", condition_type: "chain", condition_value: 20, description: "20é€£é–ã‚’é”æˆã›ã‚ˆ", secret: false },
  14: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ©ã‚¤ãƒˆå‹¢", condition_type: "pokedex", condition_value: 5, description: "5ä½“ã®ã¯ã‚€ã‚±ãƒ„ã‚’ç™ºè¦‹ï¼ˆå›³é‘‘ã«ç™»éŒ²ï¼‰", secret: false },
  15: { title: "ã¯ã‚€ã‚±ãƒ„ã‚ªã‚¿ã‚¯", condition_type: "pokedex", condition_value: 10, description: "10ä½“ã®ã¯ã‚€ã‚±ãƒ„ã‚’ç™ºè¦‹ï¼ˆå›³é‘‘ã«ç™»éŒ²ï¼‰", secret: false },
  16: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ‹ã‚¹ãƒˆ", condition_type: "pokedex", condition_value: 15, description: "15ä½“ã®ã¯ã‚€ã‚±ãƒ„ã‚’ç™ºè¦‹ï¼ˆå›³é‘‘ã«ç™»éŒ²ï¼‰", secret: false },
  17: { title: "ã¯ã‚€ã‚±ãƒ„ãƒã‚¤ã‚¹ã‚¿ãƒ¼", condition_type: "pokedex", condition_value: 20, description: "20ä½“ã®ã¯ã‚€ã‚±ãƒ„ã‚’ç™ºè¦‹ï¼ˆå›³é‘‘ã«ç™»éŒ²ï¼‰", secret: false },
  18: { title: "ã¯ã‚€ã‚±ãƒ„ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼", condition_type: "pokedex_complete", condition_value: 24, description: "ã¯ã‚€ã‚±ãƒ„å›³é‘‘ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ", secret: false },
  19: { title: "ã¯ã‚€ã‚±ãƒ„è¦‹ç¿’ã„", condition_type: "games_played", condition_value: 5, description: "ã‚²ãƒ¼ãƒ ã‚’5å›ãƒ—ãƒ¬ã‚¤", secret: false },
  20: { title: "ã¯ã‚€ã‚±ãƒ„ã‚¢ãƒãƒãƒ¥ã‚¢", condition_type: "games_played", condition_value: 10, description: "ã‚²ãƒ¼ãƒ ã‚’10å›ãƒ—ãƒ¬ã‚¤", secret: false },
  21: { title: "ã¯ã‚€ã‚±ãƒ„ãƒãƒ‹ã‚¢", condition_type: "games_played", condition_value: 30, description: "ã‚²ãƒ¼ãƒ ã‚’30å›ãƒ—ãƒ¬ã‚¤", secret: false },
  22: { title: "ã¯ã‚€ã‚±ãƒ„ã®ç”³ã—å­", condition_type: "games_played", condition_value: 60, description: "ã‚²ãƒ¼ãƒ ã‚’60å›ãƒ—ãƒ¬ã‚¤", secret: false },
  23: { title: "ã¯ã‚€ã‚±ãƒ„ä¸­æ¯’", condition_type: "games_played", condition_value: 100, description: "ã‚²ãƒ¼ãƒ ã‚’100å›ãƒ—ãƒ¬ã‚¤", secret: false },
  24: { title: "ã¯ã‚€ã‚±ãƒ„å»ƒäºº", condition_type: "games_played", condition_value: 300, description: "ã‚²ãƒ¼ãƒ ã‚’300å›ãƒ—ãƒ¬ã‚¤", secret: false },
  25: { title: "ã¯ã‚€ã‚±ãƒ„ç•Œã®ä½äºº", condition_type: "games_played", condition_value: 500, description: "ã‚²ãƒ¼ãƒ ã‚’500å›ãƒ—ãƒ¬ã‚¤", secret: false },
  26: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼", condition_type: "cleared_blocks", condition_value: 200, description: "200ã‚±ãƒ„æ¶ˆå»ã‚’é”æˆã›ã‚ˆ", secret: false },
  27: { title: "ã¯ã‚€ã‚±ãƒ„ãƒãƒ³ã‚¿ãƒ¼", condition_type: "cleared_blocks", condition_value: 500, description: "500ã‚±ãƒ„æ¶ˆå»ã‚’é”æˆã›ã‚ˆ", secret: false },
  28: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ãƒ¤ãƒ¼", condition_type: "cleared_blocks", condition_value: 1000, description: "1000ã‚±ãƒ„æ¶ˆå»ã‚’é”æˆã›ã‚ˆ", secret: false },
  29: { title: "ã¯ã‚€ã‚±ãƒ„ç„¡åŒ", condition_type: "cleared_blocks", condition_value: 2000, description: "2000ã‚±ãƒ„æ¶ˆå»ã‚’é”æˆã›ã‚ˆ", secret: false },
  30: { title: "ã¯ã‚€ã‚±ãƒ„ã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼", condition_type: "cleared_blocks", condition_value: 3000, description: "3000ã‚±ãƒ„æ¶ˆå»ã‚’é”æˆã›ã‚ˆ", secret: false },
  31: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ“ãƒƒã‚°ãƒãƒ³", condition_type: "cleared_blocks", condition_value: 5000, description: "5000ã‚±ãƒ„æ¶ˆå»ã‚’é”æˆã›ã‚ˆ", secret: false },
  32: { title: "ã¯ã‚€ã‚±ãƒ„ä¿®è¡Œä¸­", condition_type: "time_mode_play", condition_value: 1, description: "åˆ¶é™æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ã§1å›ãƒ—ãƒ¬ã‚¤", secret: false },
  33: { title: "æ™‚ã‚’é§†ã‘ã‚‹ã¯ã‚€ã‚±ãƒ„", condition_type: "time_mode_play", condition_value: 5, description: "åˆ¶é™æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ã§5å›ãƒ—ãƒ¬ã‚¤", secret: false },
  34: { title: "ã¯ã‚€ã‚±ãƒ„ã®åŒ–èº«", condition_type: "time_mode_play", condition_value: 10, description: "åˆ¶é™æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ã§10å›ãƒ—ãƒ¬ã‚¤", secret: false },
  35: { title: "ã¯ã‚€ã‚±ãƒ„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥", condition_type: "fast_clear_60", condition_value: 60, description: "60ç§’ä»¥å†…ã§ã‚¯ãƒªã‚¢", secret: false },
  // â—‹â—‹ãƒ©ãƒãƒ¼ç§°å·ï¼ˆå„ã¯ã‚€ã‚±ãƒ„ç™ºè¦‹æ™‚ã«å–å¾—ï¼‰
  101: { title: "ã‚ªãƒ¬ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 1, description: "ã‚ªãƒ¬ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  102: { title: "ãƒ‘ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ³ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 2, description: "ãƒ‘ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ³ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  103: { title: "é»„é‡‘æ¯”ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 3, description: "é»„é‡‘æ¯”ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  104: { title: "ãµã‚‰ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 4, description: "ãµã‚‰ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  105: { title: "ãƒ‡ãƒªã‚·ãƒ£ã‚¹ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 5, description: "ãƒ‡ãƒªã‚·ãƒ£ã‚¹ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  106: { title: "ã‚„ã°ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 6, description: "ã‚„ã°ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  107: { title: "ã±ã‚“ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 7, description: "ã±ã‚“ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  108: { title: "å¤ã®å¤ªé™½ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 8, description: "å¤ã®å¤ªé™½ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  109: { title: "èŠ±ç«ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 9, description: "èŠ±ç«ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  110: { title: "ãƒ—ãƒ¼ãƒ«ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 10, description: "ãƒ—ãƒ¼ãƒ«ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  111: { title: "ã²ã¾ã‚ã‚Šã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 11, description: "ã²ã¾ã‚ã‚Šã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  112: { title: "ã‹ãæ°·ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 12, description: "ã‹ãæ°·ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  113: { title: "ç´…è‘‰ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 13, description: "ç´…è‘‰ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  114: { title: "æ —æ‹¾ã„ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 14, description: "æ —æ‹¾ã„ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  115: { title: "ãŠæœˆè¦‹ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 15, description: "ãŠæœˆè¦‹ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  116: { title: "ã‚³ã‚¹ãƒ¢ã‚¹ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 16, description: "ã‚³ã‚¹ãƒ¢ã‚¹ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  117: { title: "èª­æ›¸ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 17, description: "èª­æ›¸ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  118: { title: "èŠ¸è¡“ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 18, description: "èŠ¸è¡“ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  119: { title: "é›ªã ã‚‹ã¾ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 19, description: "é›ªã ã‚‹ã¾ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  120: { title: "ã‚¯ãƒªã‚¹ãƒã‚¹ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 20, description: "ã‚¯ãƒªã‚¹ãƒã‚¹ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  121: { title: "ãŠæ­£æœˆã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 21, description: "ãŠæ­£æœˆã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  122: { title: "æ¸©æ³‰ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 22, description: "æ¸©æ³‰ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  123: { title: "ã“ãŸã¤ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 23, description: "ã“ãŸã¤ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false },
  124: { title: "é›ªæ™¯è‰²ã‚±ãƒ„ãƒ©ãƒãƒ¼", condition_type: "pokedex_unlock", condition_value: 24, description: "é›ªæ™¯è‰²ã‚±ãƒ„ã‚’å›³é‘‘ã«ç™»éŒ²ã—ãŸè¨¼", secret: false }
};

var POKEDEX_DATA = {
  1: { name: "ã‚ªãƒ¬ã‚±ãƒ„", owner: "ã‚«ãƒ•ã‚§ã‚ªãƒ¬", youtubeUrl: "", description: "ã‚«ãƒ•ã‚§ã‚ªãƒ¬ã®ç¾å‘³ã—ãã†ãªã‚±ãƒ„" },
  2: { name: "ãƒ‘ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ³", owner: "ã‹ã‚Œã‚Œ", youtubeUrl: "", description: "ãƒ‘ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ³ã¨å¼¾ã‚€ã‚±ãƒ„" },
  3: { name: "é»„é‡‘æ¯”ã‚±ãƒ„", owner: "ã”ã£ãŸ", youtubeUrl: "", description: "å®Œç’§ãªé»„é‡‘æ¯”ã§ä½œã‚‰ã‚ŒãŸã‚±ãƒ„" },
  4: { name: "ãµã‚‰ã‚±ãƒ„", owner: "ãƒ•ãƒ©ãƒ³", youtubeUrl: "", description: "ãµã‚‰ãµã‚‰ã¨é­…åŠ›çš„ãªã‚±ãƒ„" },
  5: { name: "ãƒ‡ãƒªã‚·ãƒ£ã‚¹ã‚±ãƒ„", owner: "ã™ã·ã‚‚ï½ã­", youtubeUrl: "", description: "ç¾å‘³ã—ãã†ãªãƒ‡ãƒªã‚·ãƒ£ã‚¹ã‚±ãƒ„" },
  6: { name: "ã‚„ã°ã‚±ãƒ„", owner: "ã‚¢ãƒãƒ¬ãƒƒãƒ†ã‚£", youtubeUrl: "", description: "ã‚„ã°ã„ãã‚‰ã„ç´ æ™´ã‚‰ã—ã„ã‚±ãƒ„" },
  7: { name: "ã±ã‚“ã‚±ãƒ„", owner: "ã±ã‚“ãª", youtubeUrl: "", description: "ãµã‚ãµã‚ãƒ‘ãƒ³ã®ã‚ˆã†ãªã‚±ãƒ„" },
  8: { name: "å¤ã®å¤ªé™½ã‚±ãƒ„", owner: "ãªã¤ã¡ã‚ƒã‚“", youtubeUrl: "", description: "å¤ã®å¤ªé™½ã®ã‚ˆã†ã«è¼ãã‚±ãƒ„" },
  9: { name: "èŠ±ç«ã‚±ãƒ„", owner: "ã¯ãªã³ã¡ã‚ƒã‚“", youtubeUrl: "", description: "èŠ±ç«ã®ã‚ˆã†ã«ç¾ã—ã„ã‚±ãƒ„" },
  10: { name: "ãƒ—ãƒ¼ãƒ«ã‚±ãƒ„", owner: "ã™ã„ã¡ã‚ƒã‚“", youtubeUrl: "", description: "ãƒ—ãƒ¼ãƒ«ã§æ³³ãã‚±ãƒ„" },
  11: { name: "ã²ã¾ã‚ã‚Šã‚±ãƒ„", owner: "ã²ã¾ã‚Šã¡ã‚ƒã‚“", youtubeUrl: "", description: "ã²ã¾ã‚ã‚Šã®ã‚ˆã†ã«å…ƒæ°—ãªã‚±ãƒ„" },
  12: { name: "ã‹ãæ°·ã‚±ãƒ„", owner: "ã‹ãã¡ã‚ƒã‚“", youtubeUrl: "", description: "å†·ãŸãã¦ç¾å‘³ã—ãã†ãªã‚±ãƒ„" },
  13: { name: "ç´…è‘‰ã‚±ãƒ„", owner: "ã‚‚ã¿ã˜ã¡ã‚ƒã‚“", youtubeUrl: "", description: "ç´…è‘‰ã®ã‚ˆã†ã«ç¾ã—ã„ã‚±ãƒ„" },
  14: { name: "æ —æ‹¾ã„ã‚±ãƒ„", owner: "ãã‚Šã¡ã‚ƒã‚“", youtubeUrl: "", description: "æ —æ‹¾ã„ãŒæ¥½ã—ã„ã‚±ãƒ„" },
  15: { name: "ãŠæœˆè¦‹ã‚±ãƒ„", owner: "ã¤ãã¡ã‚ƒã‚“", youtubeUrl: "", description: "ãŠæœˆè¦‹ã‚’ã™ã‚‹ã‚±ãƒ„" },
  16: { name: "ã‚³ã‚¹ãƒ¢ã‚¹ã‚±ãƒ„", owner: "ã“ã™ã‚‚ã¡ã‚ƒã‚“", youtubeUrl: "", description: "ã‚³ã‚¹ãƒ¢ã‚¹ã®ã‚ˆã†ã«å¯æ†ãªã‚±ãƒ„" },
  17: { name: "èª­æ›¸ã‚±ãƒ„", owner: "ã»ã‚“ã¡ã‚ƒã‚“", youtubeUrl: "", description: "èª­æ›¸ã®ç§‹ã®ã‚±ãƒ„" },
  18: { name: "èŠ¸è¡“ã‚±ãƒ„", owner: "ã‚ãƒ¼ã¨ã¡ã‚ƒã‚“", youtubeUrl: "", description: "èŠ¸è¡“çš„ãªã‚±ãƒ„" },
  19: { name: "é›ªã ã‚‹ã¾ã‚±ãƒ„", owner: "ã‚†ãã¡ã‚ƒã‚“", youtubeUrl: "", description: "é›ªã ã‚‹ã¾ã®ã‚ˆã†ãªã‚±ãƒ„" },
  20: { name: "ã‚¯ãƒªã‚¹ãƒã‚¹ã‚±ãƒ„", owner: "ãã‚Šã™ã¡ã‚ƒã‚“", youtubeUrl: "", description: "ã‚¯ãƒªã‚¹ãƒã‚¹ã«ã´ã£ãŸã‚Šãªã‚±ãƒ„" },
  21: { name: "ãŠæ­£æœˆã‚±ãƒ„", owner: "ã—ã‚‡ã†ã¡ã‚ƒã‚“", youtubeUrl: "", description: "ãŠæ­£æœˆã‚’ç¥ã†ã‚±ãƒ„" },
  22: { name: "æ¸©æ³‰ã‚±ãƒ„", owner: "ãŠã‚“ã›ã‚“ã¡ã‚ƒã‚“", youtubeUrl: "", description: "æ¸©æ³‰ã§ã»ã£ã“ã‚Šã‚±ãƒ„" },
  23: { name: "ã“ãŸã¤ã‚±ãƒ„", owner: "ã“ãŸã¤ã¡ã‚ƒã‚“", youtubeUrl: "", description: "ã“ãŸã¤ã§ã¾ã£ãŸã‚Šã‚±ãƒ„" },
  24: { name: "é›ªæ™¯è‰²ã‚±ãƒ„", owner: "ã›ã¤ã¡ã‚ƒã‚“", youtubeUrl: "", description: "é›ªæ™¯è‰²ã®ã‚ˆã†ã«ç¾ã—ã„ã‚±ãƒ„" }
};

var userStats = {
  maxScore: 0,
  maxChain: 0,
  gamesPlayed: 0,
  totalCleared: 0,
  timeModeClears: 0,
  timeModePlayCount: 0,
  selectedTitle: 1,
  selectedIcon: 0,
  fastClear60: false // 60ç§’ä»¥å†…ã‚¯ãƒªã‚¢é”æˆãƒ•ãƒ©ã‚°
};

// UIé–¢æ•°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½è¿½åŠ ï¼‰
function selectStage(stageIndex) {
  console.log('ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ:', stageIndex);
  var stageBtns = document.querySelectorAll('.stage-btn');
  stageBtns.forEach(function(btn) { btn.classList.remove('active'); });
  if (stageBtns[stageIndex]) {
    stageBtns[stageIndex].classList.add('active');
  }
  currentStage = stageIndex;
}

function startGame() {
  console.log('ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ');
  try {
    IMAGE_MANAGER.loadStageImages(currentStage);
    gameStarted = true;
    
    var startScreen = document.getElementById('startScreen');
    var gameArea = document.getElementById('gameArea');
    
    if (startScreen) {
      startScreen.style.display = 'none';
    }
    
    if (gameArea) {
      gameArea.classList.add('active');
    }
    
    // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½: ã‚²ãƒ¼ãƒ ç”»é¢ã«ç§»å‹•
    BROWSER_BACK.pushState('game');
    
    initGame();
  } catch (error) {
    console.error('ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
    alert('ã‚²ãƒ¼ãƒ é–‹å§‹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
  }
}

function showPokedex() {
  console.log('å›³é‘‘ã‚’è¡¨ç¤º');
  
  // å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç”»åƒã‚’ç¢ºå®Ÿã«èª­ã¿è¾¼ã‚€
  IMAGE_MANAGER.loadAllStageImages();
  
  var existingPokedex = document.getElementById('pokedexScreen');
  if (existingPokedex && existingPokedex.style.display === 'flex') {
    existingPokedex.style.display = 'none';
    return;
  }
  
  var pokedexScreen = document.getElementById('pokedexScreen');
  var pokedexGrid = document.getElementById('pokedexGrid');
  
  if (!pokedexScreen || !pokedexGrid) {
    console.error('å›³é‘‘è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½: å›³é‘‘ç”»é¢ã«ç§»å‹•
  BROWSER_BACK.pushState('pokedex');
  
  var pokedex = loadPokedex();
  pokedexGrid.innerHTML = '';
  
  var stageNames = ['æ˜¥ã®ã‚±ãƒ„', 'å¤ã®ã‚±ãƒ„', 'ç§‹ã®ã‚±ãƒ„', 'å†¬ã®ã‚±ãƒ„'];
  
  for (var i = 1; i <= 24; i++) {
    var key = 'type_' + i;
    var entry = pokedex[key] || { count: 0, discovered: false };
    var stageIndex = Math.floor((i - 1) / 6);
    var data = POKEDEX_DATA[i] || { name: '???', owner: '???', description: '???' };
    
    var entryDiv = document.createElement('div');
    entryDiv.className = 'pokedex-entry ' + (entry.discovered ? 'discovered' : 'undiscovered');
    
    if (entry.discovered) {
      entryDiv.setAttribute('data-id', i);
      entryDiv.style.cursor = 'pointer';
      entryDiv.onclick = function() {
        var id = parseInt(this.getAttribute('data-id'));
        showPokedexDetail(id);
      };
    }
    
    if (entry.discovered) {
      var imageDisplay = getSafeImageDisplay(i, 'small');
      
      entryDiv.innerHTML = 
        '<div class="pokedex-image" style="font-size: 32px; margin-bottom: 8px; height: 40px; display: flex; align-items: center; justify-content: center;">' + 
        imageDisplay +
        '</div>' +
        '<div style="font-weight: bold; font-size: 10px; margin: 4px 0;">No.' + String(i).padStart(2, '0') + '</div>' +
        '<div style="font-weight: bold; font-size: 12px; margin: 2px 0; color: #ffeb3b;">' + data.name + '</div>' +
        '<div style="font-size: 10px; opacity: 0.8; margin: 2px 0;">' + data.owner + '</div>' +
        '<div style="font-size: 9px; margin-top: 4px; color: #FFD700; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 8px; font-weight: bold;">æ¶ˆå»æ•°: ' + entry.count + '</div>';
    } else {
      entryDiv.innerHTML = 
        '<div style="font-size: 32px; margin-bottom: 8px; height: 40px; display: flex; align-items: center; justify-content: center;">â“</div>' +
        '<div style="font-weight: bold; font-size: 10px; margin: 4px 0;">No.' + String(i).padStart(2, '0') + '</div>' +
        '<div style="font-size: 10px; opacity: 0.8; margin: 2px 0; color: #ffffff;">' + stageNames[stageIndex] + '</div>' +
        '<div style="font-size: 11px; margin-top: 6px; color: #333; background: rgba(255,255,255,0.95); padding: 4px 8px; border-radius: 10px; font-weight: bold;">' + entry.count + '/30</div>';
    }
    
    pokedexGrid.appendChild(entryDiv);
  }
  
  pokedexScreen.style.display = 'flex';
}

function showPokedexDetail(id) {
  var data = POKEDEX_DATA[id];
  var pokedex = loadPokedex();
  var entry = pokedex['type_' + id] || { count: 0, discovered: false };
  var stageIndex = Math.floor((id - 1) / 6);
  var stageNames = ['æ˜¥ã®ã‚±ãƒ„', 'å¤ã®ã‚±ãƒ„', 'ç§‹ã®ã‚±ãƒ„', 'å†¬ã®ã‚±ãƒ„'];
  
  if (!entry.discovered) return;
  
  var imageDisplay = getSafeImageDisplay(id, 'large');
  
  var detailScreen = document.createElement('div');
  detailScreen.className = 'overlay';
  detailScreen.style.display = 'flex';
  detailScreen.style.zIndex = '1001';
  
  detailScreen.innerHTML = 
    '<div class="card" style="max-width: 480px; text-align: center;">' +
      '<div style="position: relative;">' +
        '<button onclick="this.parentElement.parentElement.parentElement.remove()" style="position: absolute; top: -10px; right: -10px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; color: #333;">Ã—</button>' +
        '<div style="margin: 20px 0; display: flex; justify-content: center;">' + imageDisplay + '</div>' +
        '<h3 style="margin: 16px 0; font-size: 24px;">' + data.name + '</h3>' +
        '<div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px; margin: 16px 0;">' +
          '<div style="font-size: 14px; margin: 8px 0;"><strong>ğŸ“± æŒã¡ä¸»:</strong> ' + data.owner + '</div>' +
          '<div style="font-size: 14px; margin: 8px 0;"><strong>ğŸ·ï¸ åˆ†é¡:</strong> ' + stageNames[stageIndex] + '</div>' +
          '<div style="font-size: 14px; margin: 8px 0;"><strong>ğŸ’¥ æ¶ˆå»æ•°:</strong> ' + entry.count + 'å€‹</div>' +
          '<div style="font-size: 12px; margin: 12px 0; line-height: 1.4;">' + data.description + '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  
  document.body.appendChild(detailScreen);
}

function closePokedex() {
  var pokedexScreen = document.getElementById('pokedexScreen');
  if (pokedexScreen) {
    pokedexScreen.style.display = 'none';
  }
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½: ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹
  BROWSER_BACK.currentScreen = 'start';
}

function showMyPage() {
  console.log('ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º');
  
  // å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç”»åƒã‚’ç¢ºå®Ÿã«èª­ã¿è¾¼ã‚€
  IMAGE_MANAGER.loadAllStageImages();
  
  // æ—¢å­˜ã®å‹•çš„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã¿ã‚’å‰Šé™¤ï¼ˆå›ºå®šã®å›³é‘‘ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯æ®‹ã™ï¼‰
  var existingDynamicOverlays = document.querySelectorAll('.overlay:not(#pokedexScreen):not(#gameOverlay)');
  existingDynamicOverlays.forEach(function(overlay) { overlay.remove(); });
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½: ãƒã‚¤ãƒšãƒ¼ã‚¸ã«ç§»å‹•
  BROWSER_BACK.pushState('mypage');
  
  var myPageScreen = document.createElement('div');
  myPageScreen.className = 'overlay';
  myPageScreen.style.display = 'flex';
  myPageScreen.style.zIndex = '1001';
  
  var bestScores = loadScores();
  var selectedIcon = userStats.selectedIcon;
  var iconDisplay = '';
  
  if (selectedIcon > 0 && selectedIcon <= 24) {
    var pokedex = loadPokedex();
    var entry = pokedex['type_' + selectedIcon];
    if (entry && entry.discovered) {
      iconDisplay = getSafeImageDisplay(selectedIcon, 'profile');
    }
  }
  
  if (!iconDisplay) {
    iconDisplay = '<div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #ccc, #999); display: flex; align-items: center; justify-content: center; font-size: 14px; color: #666; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">No Image</div>';
  }
  
  myPageScreen.innerHTML = 
    '<div class="card" style="max-width: 400px; text-align: center;">' +
      '<button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; color: #333;">Ã—</button>' +
      '<h3 style="margin: 16px 0;">ğŸ“„ ãƒã‚¤ãƒšãƒ¼ã‚¸</h3>' +
      '<div style="margin: 20px 0; display: flex; justify-content: center; align-items: center;">' + iconDisplay + '</div>' +
      '<div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; margin: 16px 0; backdrop-filter: blur(10px);">' +
        '<div style="font-size: 18px; font-weight: bold; color: #ffeb3b;">ã€Œ' + getSelectedTitleName() + 'ã€</div>' +
      '</div>' +
      '<div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px; margin: 16px 0; backdrop-filter: blur(10px);">' +
        '<div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">ğŸ† ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢</div>' +
        '<div style="font-size: 14px;" id="mypage-best1">1ä½: ' + (bestScores[0] ? bestScores[0].s : '-') + '</div>' +
        '<div style="font-size: 14px;" id="mypage-best2">2ä½: ' + (bestScores[1] ? bestScores[1].s : '-') + '</div>' +
        '<div style="font-size: 14px;" id="mypage-best3">3ä½: ' + (bestScores[2] ? bestScores[2].s : '-') + '</div>' +
      '</div>' +
      '<div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px; margin: 16px 0; backdrop-filter: blur(10px);">' +
        '<div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">ğŸ“Š çµ±è¨ˆæƒ…å ±</div>' +
        '<div style="font-size: 12px; margin: 4px 0;">ğŸ® ãƒ—ãƒ¬ã‚¤å›æ•°: ' + userStats.gamesPlayed + '</div>' +
        '<div style="font-size: 12px; margin: 4px 0;">âš¡ æœ€é«˜ãƒã‚§ã‚¤ãƒ³: ' + userStats.maxChain + '</div>' +
        '<div style="font-size: 12px; margin: 4px 0;">ğŸ’¥ æ¶ˆå»ç·æ•°: ' + userStats.totalCleared + '</div>' +
      '</div>' +
      '<div class="row" style="margin-top: 20px; gap: 8px;">' +
        '<button onclick="showTitleList()" style="flex: 1;">ğŸ† ç§°å·å¤‰æ›´</button>' +
        '<button onclick="showIconSelect()" style="flex: 1;">ğŸ–¼ï¸ ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´</button>' +
      '</div>' +
      '<div class="row" style="margin-top: 12px; gap: 8px;">' +
        '<button onclick="shareMyPage(\'x\')" style="flex: 1; background: linear-gradient(135deg, #000, #333); color: white; border-radius: 20px; padding: 10px 16px; font-size: 14px;">Xã§ã‚·ã‚§ã‚¢</button>' +
        '<button onclick="shareMyPage(\'line\')" style="flex: 1; background: linear-gradient(135deg, #00C300, #00B900); color: white; border-radius: 20px; padding: 10px 16px; font-size: 14px;">LINEã§ã‚·ã‚§ã‚¢</button>' +
      '</div>' +
    '</div>';
  
  document.body.appendChild(myPageScreen);
}

function shareToX() {
  var text = encodeURIComponent('ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆã§éŠã‚“ã§ã¿ã¦ã­ï¼ğŸ¹âœ¨\nã¯ã‚€ã‚±ãƒ„ã‚’4å€‹ä»¥ä¸Šã¤ãªã’ã¦ã€ã·ã‚‹ã·ã‚‹æ¶ˆã™ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ \n\n#ã¯ã‚€ãƒãƒ© #ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆ');
  var url = encodeURIComponent('https://hamuchiranagaya.github.io/ketsu-poyo/');
  window.open('https://twitter.com/intent/tweet?text=' + text + '&url=' + url, '_blank');
}

function copyURL() {
  var gameUrl = 'https://hamuchiranagaya.github.io/ketsu-poyo/';
  var textArea = document.createElement('textarea');
  textArea.value = gameUrl;
  document.body.appendChild(textArea);
  textArea.select();
  document.execCommand('copy');
  document.body.removeChild(textArea);
  
  var copyText = document.getElementById('copyText');
  if (copyText) {
    copyText.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
    setTimeout(function() {
      copyText.textContent = 'URLã‚³ãƒ”ãƒ¼';
    }, 2000);
  }
}

function simpleInstall() {
  alert('ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®è¿½åŠ æ–¹æ³•\n\nã€ŠiPhone/iPad (Safari)ã€‹\n1. ä¸‹éƒ¨ã®ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ï¼ˆâ–¡â†‘ï¼‰ã‚’ã‚¿ãƒƒãƒ—\n2. ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ\n\nã€ŠAndroid (Chrome)ã€‹\n1. å³ä¸Šã®ã€Œâ‹®ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¿ãƒƒãƒ—\n2. ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ\n\nã€ŠPC (Chrome)ã€‹\n1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å³ã®ã€Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n2. ã¾ãŸã¯å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€');
}

function backToStart() {
  gameStarted = false;
  document.getElementById('gameArea').classList.remove('active');
  document.getElementById('startScreen').style.display = 'block';
  hideGameOverlay();
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½: ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹
  BROWSER_BACK.currentScreen = 'start';
}

function restart() {
  grid = resetGrid();
  score = 0;
  chain = 0;
  gameOver = false;
  dropTimer = 0;
  resolving = false;
  phase = 0;
  phaseTimer = 0;
  particles = [];
  
  falling = newPair();
  nextPair = newPair();
  
  updateHUD();
  hideGameOverlay();
}

function shareResult() {
  var text = encodeURIComponent('ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆã§ã‚¹ã‚³ã‚¢ ' + score + ' ç‚¹ã‚’è¨˜éŒ²ï¼ğŸ¹âœ¨\nã¯ã‚€ã‚±ãƒ„ã‚’4å€‹ä»¥ä¸Šã¤ãªã’ã¦ã€ã·ã‚‹ã·ã‚‹æ¶ˆã™ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ \n\n#ã¯ã‚€ãƒãƒ© #ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆ');
  var url = encodeURIComponent('https://hamuchiranagaya.github.io/ketsu-poyo/');
  window.open('https://twitter.com/intent/tweet?text=' + text + '&url=' + url, '_blank');
}

// æ“ä½œé–¢æ•°
function moveLeft() {
  if (!falling || gameOver || resolving) return;
  if (canMove(falling, -1, 0)) {
    falling.cx -= 1;
  }
}

function moveRight() {
  if (!falling || gameOver || resolving) return;
  if (canMove(falling, 1, 0)) {
    falling.cx += 1;
  }
}

function softDrop() {
  if (!falling || gameOver || resolving) return;
  if (canMove(falling, 0, 1)) {
    falling.cy += 1;
  } else {
    lockPiece();
  }
}

function hardDrop() {
  if (!falling || gameOver || resolving) return;
  while (canMove(falling, 0, 1)) {
    falling.cy += 1;
  }
  lockPiece();
}

function rotate() {
  if (!falling || gameOver || resolving) return;
  
  var nextRot = (falling.rot + 1) % 4;
  var newBlocks = getRotatedBlocks(
    nextRot, 
    falling.blocks[0].type, 
    falling.blocks[1].type
  );
  
  var tempPair = {
    cx: falling.cx,
    cy: falling.cy,
    blocks: newBlocks,
    rot: nextRot
  };
  
  if (canMove(tempPair, 0, 0)) {
    falling.blocks = newBlocks;
    falling.rot = nextRot;
  }
}

function toggleTimeMode() {
  timeMode = !timeMode;
  var timeWrap = document.getElementById('timeWrap');
  var modeBtn = document.getElementById('mode');
  
  if (timeMode) {
    timeLeft = 180000;
    if (timeWrap) timeWrap.style.display = 'inline';
    if (modeBtn) modeBtn.textContent = 'åˆ¶é™æ™‚é–“:ON';
  } else {
    if (timeWrap) timeWrap.style.display = 'none';
    if (modeBtn) modeBtn.textContent = 'åˆ¶é™æ™‚é–“:OFF';
  }
}

// ã‚²ãƒ¼ãƒ é–¢æ•°
function initGame() {
  console.log('ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');
  canvas = document.getElementById('game');
  ctx = canvas.getContext('2d');
  W = canvas.width;
  H = canvas.height;
  TILE = Math.floor(Math.min(W / COLS, H / ROWS));
  PX = Math.floor((W - COLS * TILE) / 2);
  PY = Math.floor((H - ROWS * TILE) / 2);
  
  fit();
  restart();
  requestAnimationFrame(gameLoop);
}

function getSafeImageDisplay(id, size) {
  var stageIndex = Math.floor((id - 1) / 6);
  var stageIcons = ['ğŸŒ¸', 'ğŸŒ»', 'ğŸ‚', 'â„ï¸'];
  
  // ä¿®æ­£: ç›´æ¥IDã‚’ä½¿ã£ã¦ç”»åƒã‚’å–å¾—
  var img = IMAGE_MANAGER.getImageById(id);
  
  if (img) {
    if (size === 'large') {
      return '<img src="' + img.src + '" style="width: 80px; height: 80px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">';
    } else if (size === 'profile') {
      return '<img src="' + img.src + '" style="width: 80px; height: 80px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">';
    } else if (size === 'icon') {
      return '<div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; margin: 0 auto 4px auto;"><img src="' + img.src + '" style="width: 100%; height: 100%; object-fit: cover;"></div>';
    } else {
      return '<img src="' + img.src + '" style="width: 32px; height: 32px; border-radius: 4px;">';
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
  if (size === 'large') {
    return '<div style="width: 80px; height: 80px; border-radius: 12px; background: linear-gradient(135deg, #4facfe, #00f2fe); display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); color: white;">' + stageIcons[stageIndex] + '</div>';
  } else if (size === 'profile') {
    return '<div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #4facfe, #00f2fe); display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); color: white;">' + stageIcons[stageIndex] + '</div>';
  } else if (size === 'icon') {
    return '<div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #4facfe, #00f2fe); display: flex; align-items: center; justify-content: center; font-size: 30px; margin: 0 auto 4px auto; color: white;">' + stageIcons[stageIndex] + '</div>';
  } else {
    return '<div style="font-size: 32px;">' + stageIcons[stageIndex] + '</div>';
  }
}

function getSelectedTitleName() {
  var titleData = TITLE_DATA[userStats.selectedTitle];
  return titleData ? titleData.title : 'ã¯ã‚€ã‚±ãƒ„ãƒ“ã‚®ãƒŠãƒ¼';
}

function fit() {
  if (!gameStarted) return;
  
  var availableWidth = window.innerWidth - 16;
  var availableHeight = window.innerHeight - 280;
  var maxWidth = 500;
  var maxHeight = 800;
  var scaleByWidth = Math.min(availableWidth, maxWidth) / W;
  var scaleByHeight = Math.min(availableHeight, maxHeight) / H;
  var scale = Math.min(scaleByWidth, scaleByHeight);
  var isSmallScreen = window.innerWidth <= 768;
  var finalScale = isSmallScreen ? Math.max(scale, availableWidth / W * 0.9) : Math.max(scale, 0.8);
  
  canvas.style.width = (W * finalScale) + 'px';
  canvas.style.height = (H * finalScale) + 'px';
  
  var btnBar = document.querySelector('.btnbar');
  if (btnBar) {
    btnBar.style.maxWidth = (W * finalScale) + 'px';
    btnBar.style.width = (W * finalScale) + 'px';
  }
}

function empty() {
  return { type: 0, mark: false, seed: Math.random() * 1000 };
}

function resetGrid() {
  return Array.from({ length: ROWS }, function() { 
    return Array.from({ length: COLS }, empty);
  });
}

function randomType() {
  return 1 + Math.floor(Math.random() * TYPES);
}

function newPair() {
  return {
    cx: Math.floor(COLS / 2),
    cy: -1,
    blocks: [
      { dx: 0, dy: 0, type: randomType() },
      { dx: 0, dy: -1, type: randomType() }
    ],
    rot: 0
  };
}

function updateHUD() {
  var scoreEl = document.getElementById('score');
  var chainEl = document.getElementById('chain');
  if (scoreEl) scoreEl.textContent = score;
  if (chainEl) chainEl.textContent = chain;
}

function canMove(pair, dx, dy) {
  for (var i = 0; i < pair.blocks.length; i++) {
    var block = pair.blocks[i];
    var x = pair.cx + block.dx + dx;
    var y = pair.cy + block.dy + dy;
    
    if (x < 0 || x >= COLS || y >= ROWS) {
      return false;
    }
    
    if (y >= 0 && grid[y][x].type) {
      return false;
    }
  }
  return true;
}

function getRotatedBlocks(rot, type0, type1) {
  var block0 = { dx: 0, dy: 0, type: type0 };
  var block1 = { dx: 0, dy: -1, type: type1 };
  
  if (rot === 1) { block1.dx = 1; block1.dy = 0; }
  if (rot === 2) { block1.dx = 0; block1.dy = 1; }
  if (rot === 3) { block1.dx = -1; block1.dy = 0; }
  
  return [block0, block1];
}

function lockPiece() {
  for (var i = 0; i < falling.blocks.length; i++) {
    var block = falling.blocks[i];
    var x = falling.cx + block.dx;
    var y = falling.cy + block.dy;
    
    if (y < 0) {
      gameOverNow('ä¸Šã¾ã§ç©ã¿ä¸ŠãŒã‚Šã¾ã—ãŸâ€¦');
      return;
    }
    
    grid[y][x] = { 
      type: block.type, 
      mark: false, 
      seed: Math.random() * 1000
    };
  }
  
  falling = null;
  dropBlocks();
  
  setTimeout(function() {
    resolving = true;
    phase = 0;
    phaseTimer = 0;
    scanForMatches();
  }, 200);
}

function processResolving() {
  phaseTimer += 16;
  
  if (phase === 0) {
    scanForMatches();
  } else if (phase === 1) {
    if (phaseTimer >= 300) {
      phase = 2;
      phaseTimer = 0;
    }
  } else if (phase === 2) {
    if (phaseTimer >= 200) {
      clearMarkedBlocks();
      dropBlocks();
      
      phase = 0;
      phaseTimer = 0;
      
      setTimeout(function() {
        if (resolving) {
          scanForMatches();
        }
      }, 100);
    }
  }
}

function scanForMatches() {
  for (var r = 0; r < ROWS; r++) {
    for (var c = 0; c < COLS; c++) {
      grid[r][c].mark = false;
    }
  }

  var visited = Array.from({ length: ROWS }, function() { return Array(COLS).fill(false); });
  var directions = [[1, 0], [-1, 0], [0, 1], [0, -1]];
  var totalCleared = 0;

  function floodFill(startR, startC) {
    var type = grid[startR][startC].type;
    var queue = [[startR, startC]];
    var cells = [[startR, startC]];
    visited[startR][startC] = true;

    while (queue.length > 0) {
      var current = queue.shift();
      var r = current[0];
      var c = current[1];
      
      for (var i = 0; i < directions.length; i++) {
        var dir = directions[i];
        var nr = r + dir[0];
        var nc = c + dir[1];
        
        if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS &&
            !visited[nr][nc] && grid[nr][nc].type === type) {
          visited[nr][nc] = true;
          queue.push([nr, nc]);
          cells.push([nr, nc]);
        }
      }
    }
    
    return cells;
  }

  for (var r = 0; r < ROWS; r++) {
    for (var c = 0; c < COLS; c++) {
      if (!visited[r][c] && grid[r][c].type) {
        var cells = floodFill(r, c);
        if (cells.length >= 4) {
          totalCleared += cells.length;
          
          cells.forEach(function(cell) {
            var rr = cell[0];
            var cc = cell[1];
            grid[rr][cc].mark = true;
            spawnBurst(PX + cc * TILE + TILE / 2, PY + rr * TILE + TILE / 2, grid[rr][cc].type);
          });
        }
      }
    }
  }

  if (totalCleared > 0) {
    chain++;
    var basePoints = totalCleared * 10;
    var chainBonus = chain > 1 ? Math.pow(2, chain - 1) : 1;
    var addedPoints = Math.floor(basePoints * chainBonus);
    
    score += addedPoints;
    
    phase = 1;
    phaseTimer = 0;
    updateHUD();
  } else {
    if (chain > 0) {
      chain = 0;
      updateHUD();
    }
    
    resolving = false;
    falling = nextPair;
    nextPair = newPair();
    
    var hasBlocks = false;
    for (var r = 0; r < ROWS; r++) {
      for (var c = 0; c < COLS; c++) {
        if (grid[r][c].type) {
          hasBlocks = true;
          break;
        }
      }
      if (hasBlocks) break;
    }
    
    if (!hasBlocks) {
      clearNow();
    }
  }
}

function clearMarkedBlocks() {
  var clearedCount = 0;
  var clearedTypes = {};
  
  for (var r = 0; r < ROWS; r++) {
    for (var c = 0; c < COLS; c++) {
      if (grid[r][c].mark) {
        var type = grid[r][c].type;
        
        if (!clearedTypes[type]) {
          clearedTypes[type] = 0;
        }
        clearedTypes[type]++;
        
        grid[r][c] = empty();
        clearedCount++;
      }
    }
  }
  
  Object.keys(clearedTypes).forEach(function(type) {
    if (type > 0) {
      addToPokedex(parseInt(type), clearedTypes[type]);
    }
  });
}

function dropBlocks() {
  for (var c = 0; c < COLS; c++) {
    var writeRow = ROWS - 1;
    
    for (var r = ROWS - 1; r >= 0; r--) {
      if (grid[r][c].type !== 0) {
        if (r !== writeRow) {
          grid[writeRow][c] = {
            type: grid[r][c].type,
            mark: false,
            seed: Math.random() * 1000
          };
          grid[r][c] = empty();
        }
        writeRow--;
      }
    }
  }
}

function spawnBurst(x, y, type) {
  var numParticles = 12;
  for (var i = 0; i < numParticles; i++) {
    var angle = (Math.PI * 2 * i) / numParticles;
    var speed = 3 + Math.random() * 4;
    particles.push({
      x: x, 
      y: y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 2,
      life: 0,
      maxLife: 600 + Math.random() * 400,
      type: type,
      size: TILE * (0.3 + Math.random() * 0.2)
    });
  }
}

function updateParticles(dt) {
  var gravity = 0.015;
  
  particles.forEach(function(p) {
    p.life += dt;
    p.x += p.vx * dt * 0.1;
    p.y += p.vy * dt * 0.1;
    p.vy += gravity * dt;
  });
  
  particles = particles.filter(function(p) { return p.life < p.maxLife; });
}

function drawBlob(x, y, size, type, alpha, shakeX, shakeY, scale) {
  if (alpha === undefined) alpha = 1;
  if (shakeX === undefined) shakeX = 0;
  if (shakeY === undefined) shakeY = 0;
  if (scale === undefined) scale = 1;
  
  ctx.save();
  ctx.globalAlpha = alpha;
  
  var cx = x + size / 2 + shakeX;
  var cy = y + size / 2 + shakeY;
  
  if (scale !== 1) {
    ctx.translate(cx, cy);
    ctx.scale(scale, scale);
    ctx.translate(-cx, -cy);
  }
  
  var imageIndex = type - 1;
  var img = IMAGE_MANAGER.getSafeImage(imageIndex);
  
  if (img) {
    try {
      ctx.drawImage(img, x + shakeX, y + shakeY, size, size);
    } catch (drawError) {
      drawColorCircle(cx, cy, size, type);
    }
  } else {
    drawColorCircle(cx, cy, size, type);
  }
  
  ctx.restore();
}

function drawColorCircle(cx, cy, size, type) {
  var r = size * 0.45;
  
  var grad = ctx.createRadialGradient(
    cx - r * 0.4, cy - r * 0.4, r * 0.2,
    cx, cy, r
  );
  var base = COLORS[(type - 1) % COLORS.length];
  grad.addColorStop(0, '#ffffff');
  grad.addColorStop(0.15, base);
  grad.addColorStop(1, '#333');
  
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.beginPath();
  ctx.arc(cx + r * 0.3, cy - r * 0.2, r * 0.15, 0, Math.PI * 2);
  ctx.fill();
}

function drawParticles() {
  for (var i = 0; i < particles.length; i++) {
    var p = particles[i];
    var alpha = Math.max(0, 1 - (p.life / p.maxLife));
    var size = p.size * alpha;
    
    ctx.save();
    ctx.globalAlpha = alpha;
    
    var img = IMAGE_MANAGER.getSafeImage(p.type - 1);
    if (img) {
      var imgSize = size * 0.3;
      ctx.drawImage(img, p.x - imgSize/2, p.y - imgSize/2, imgSize, imgSize);
    } else {
      ctx.fillStyle = COLORS[(p.type - 1) % COLORS.length];
      ctx.beginPath();
      ctx.arc(p.x, p.y, size * 0.15, 0, Math.PI * 2);
      ctx.fill();
    }
    
    ctx.restore();
  }
}

function draw() {
  if (!gameStarted) return;
  
  ctx.fillStyle = '#0f1220';
  ctx.fillRect(0, 0, W, H);
  
  for (var r = 0; r < ROWS; r++) {
    for (var c = 0; c < COLS; c++) {
      ctx.fillStyle = 'rgba(255,255,255,0.03)';
      ctx.fillRect(PX + c * TILE + 1, PY + r * TILE + 1, TILE - 2, TILE - 2);
    }
  }
  
  for (var r = 0; r < ROWS; r++) {
    for (var c = 0; c < COLS; c++) {
      var cell = grid[r][c];
      if (cell.type) {
        var alpha = 1, shakeX = 0, shakeY = 0, scale = 1;
        
        if (cell.mark) {
          if (phase === 1) {
            var amp = TILE * 0.1;
            var t = (phaseTimer + cell.seed * 15) * 0.02;
            shakeX = Math.sin(t) * amp;
            shakeY = Math.cos(t * 1.3) * amp;
          } else if (phase === 2) {
            var progress = phaseTimer / 300;
            scale = 1 + progress * 0.5;
            alpha = 1 - progress * 0.8;
          }
        }
        
        drawBlob(PX + c * TILE, PY + r * TILE, TILE, cell.type, alpha, shakeX, shakeY, scale);
      }
    }
  }
  
  if (falling) {
    for (var i = 0; i < falling.blocks.length; i++) {
      var block = falling.blocks[i];
      var x = falling.cx + block.dx;
      var y = falling.cy + block.dy;
      if (y >= 0) {
        drawBlob(PX + x * TILE, PY + y * TILE, TILE, block.type);
      }
    }
  }
  
  ctx.strokeStyle = 'rgba(255,255,255,0.2)';
  ctx.lineWidth = 2;
  ctx.strokeRect(PX - 1, PY - 1, COLS * TILE + 2, ROWS * TILE + 2);
  
  drawParticles();
}

function update(dt) {
  if (!gameStarted || gameOver) return;

  updateParticles(dt);

  if (resolving) {
    processResolving();
    return;
  }

  dropTimer += dt;
  
  var baseInterval = 1000;
  var speedUpPoints = 500;
  var speedUpAmount = 25;
  var minInterval = 250;
  
  var speedUps = Math.floor(score / speedUpPoints);
  var fallInterval = Math.max(minInterval, baseInterval - (speedUps * speedUpAmount));
  
  if (dropTimer >= fallInterval) {
    dropTimer = 0;
    if (falling) {
      softDrop();
    }
  }

  if (timeMode) {
    timeLeft -= dt;
    if (timeLeft <= 0) {
      gameOverNow('æ™‚é–“åˆ‡ã‚Œâ€¦');
      return;
    }
    var timeEl = document.getElementById('time');
    if (timeEl) {
      timeEl.textContent = Math.max(0, Math.ceil(timeLeft / 1000));
    }
  }
}

function gameLoop() {
  var now = performance.now();
  var dt = now - (gameLoop.last || now);
  gameLoop.last = now;
  
  update(dt);
  draw();
  
  requestAnimationFrame(gameLoop);
}

function gameOverNow(reason) {
  gameOver = true;
  
  setTimeout(function() {
    try {
      showGameOverlay('ğŸ¹ Game Over ğŸ¹', reason + ' ã‚¹ã‚³ã‚¢: ' + score);
    } catch (displayError) {
      alert('Game Over\n' + reason + '\nã‚¹ã‚³ã‚¢: ' + score);
    }
  }, 100);
  
  setTimeout(function() {
    try {
      var savedScores = saveScore(score);
      
      // çµ±è¨ˆæ›´æ–°ï¼ˆé‡è¦ï¼šã“ã“ã§ç§°å·ãƒã‚§ãƒƒã‚¯ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
      updateStats(score, chain, userStats.totalCleared, timeMode);
      
      showBest();
    } catch (saveError) {
      console.error('ã‚¹ã‚³ã‚¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', saveError);
    }
  }, 200);
}

function showGameOverlay(title, message) {
  try {
    var overlay = document.getElementById('gameOverlay');
    var ovTitle = document.getElementById('ovTitle');
    var ovMsg = document.getElementById('ovMsg');
    
    if (overlay && ovTitle && ovMsg) {
      ovTitle.textContent = title;
      ovMsg.textContent = message;
      
      try {
        showBest();
      } catch (bestError) {
        console.error('ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', bestError);
      }
      
      overlay.style.display = 'flex';
    } else {
      alert(title + '\n' + message);
    }
  } catch (error) {
    try {
      alert(title + '\n' + message);
    } catch (alertError) {
      console.error('ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚‚ã‚¨ãƒ©ãƒ¼:', alertError);
    }
  }
}

function hideGameOverlay() {
  var overlay = document.getElementById('gameOverlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
}

// å›³é‘‘ã‚·ã‚¹ãƒ†ãƒ     
function loadPokedex() {
  try {
    if (typeof(Storage) !== "undefined" && localStorage) {
      var data = localStorage.getItem('ham_poyo_pokedex');
      if (data) {
        return JSON.parse(data);
      }
    }
  } catch (error) {
    console.log('loadPokedex error:', error);
  }
  return {};
}

function savePokedex(pokedex) {
  try {
    if (typeof(Storage) !== "undefined" && localStorage) {
      localStorage.setItem('ham_poyo_pokedex', JSON.stringify(pokedex));
    }
  } catch (error) {
    console.log('savePokedex error:', error);
  }
}

function addToPokedex(type, count) {
  if (count === undefined) count = 1;
  var pokedex = loadPokedex();
  var key = 'type_' + type;
  
  if (!pokedex[key]) {
    pokedex[key] = { count: 0, discovered: false };
  }
  
  pokedex[key].count += count;
  
  if (pokedex[key].count >= 30 && !pokedex[key].discovered) {
    pokedex[key].discovered = true;
    showDiscoveryMessage(type);
    
    // â—‹â—‹ãƒ©ãƒãƒ¼ç§°å·ã‚’è§£æ”¾
    var laverTitleId = 100 + type; // 101-124
    if (TITLE_DATA[laverTitleId]) {
      setTimeout(function() {
        unlockTitle(laverTitleId);
      }, 1500); // ç™ºè¦‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«è¡¨ç¤º
    }
  }
  
  savePokedex(pokedex);
  updatePokedexCount();
  
  // ç§°å·ãƒã‚§ãƒƒã‚¯ï¼ˆå›³é‘‘é–¢é€£ï¼‰
  checkAndUnlockTitles();
  
  return pokedex[key];
}

function showDiscoveryMessage(type) {
  var stageNames = ['æ˜¥ã®ã‚±ãƒ„', 'å¤ã®ã‚±ãƒ„', 'ç§‹ã®ã‚±ãƒ„', 'å†¬ã®ã‚±ãƒ„'];
  var stageIndex = Math.floor((type - 1) / 6);
  var hamNumber = type;
  
  setTimeout(function() {
    alert('ğŸ‰ å›³é‘‘ã«æ–°ã—ã„ã¯ã‚€ã‚±ãƒ„ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼\n\n' + stageNames[stageIndex] + ' No.' + String(hamNumber).padStart(2, '0') + '\nãŒå›³é‘‘ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼');
  }, 500);
}

function getPokedexStats() {
  var pokedex = loadPokedex();
  var discovered = 0;
  var total = 24;
  
  for (var i = 1; i <= total; i++) {
    var key = 'type_' + i;
    if (pokedex[key] && pokedex[key].discovered) {
      discovered++;
    }
  }
  
  return { discovered: discovered, total: total };
}

function updatePokedexCount() {
  var stats = getPokedexStats();
  var countElement = document.getElementById('pokedexCount');
  if (countElement) {
    countElement.textContent = stats.discovered + '/' + stats.total;
  }
}

// ã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ  
function loadScores() {
  try {
    if (typeof Storage === "undefined" || !localStorage) {
      return [];
    }
    
    var keys = ['ham_poyo_scores', 'hamketsu_scores'];
    
    for (var i = 0; i < keys.length; i++) {
      try {
        var data = localStorage.getItem(keys[i]);
        if (data && data !== 'null') {
          var parsed = JSON.parse(data);
          if (Array.isArray(parsed)) {
            return parsed;
          }
        }
      } catch (error) {
        continue;
      }
    }
  } catch (error) {
    console.log('loadScores ã‚¨ãƒ©ãƒ¼:', error);
  }
  
  return [];
}

function saveScore(score) {
  try {
    if (!score || typeof score !== 'number' || score <= 0 || isNaN(score)) {
      return [];
    }
    
    var existingScores = loadScores();
    var newScoreEntry = { 
      s: parseInt(score), 
      t: Date.now()
    };
    
    var allScores = existingScores.slice();
    allScores.push(newScoreEntry);
    
    allScores.sort(function(a, b) { 
      var scoreA = (a && typeof a.s === 'number') ? a.s : 0;
      var scoreB = (b && typeof b.s === 'number') ? b.s : 0;
      return scoreB - scoreA; 
    });
    
    var topScores = allScores.slice(0, 3);
    var jsonString = JSON.stringify(topScores);
    
    var saveKeys = ['ham_poyo_scores', 'hamketsu_scores'];
    var saveSuccess = false;
    
    for (var i = 0; i < saveKeys.length; i++) {
      try {
        localStorage.setItem(saveKeys[i], jsonString);
        var verification = localStorage.getItem(saveKeys[i]);
        if (verification === jsonString) {
          saveSuccess = true;
        }
      } catch (saveError) {
        continue;
      }
    }
    
    if (saveSuccess) {
      return topScores;
    } else {
      return [newScoreEntry];
    }
    
  } catch (error) {
    return [{ s: score, t: Date.now() }];
  }
}

function showBest() {
  try {
    var arr = loadScores();
    
    var bestEls = [
      document.getElementById('best1'),
      document.getElementById('best2'),
      document.getElementById('best3')
    ];
    
    for (var i = 0; i < bestEls.length; i++) {
      var el = bestEls[i];
      if (el) {
        var scoreData = arr[i];
        var displayScore = '-';
        
        if (scoreData && typeof scoreData === 'object' && typeof scoreData.s === 'number') {
          displayScore = scoreData.s;
        }
        
        el.textContent = displayScore;
      }
    }
  } catch (error) {
    console.error('showBest ã‚¨ãƒ©ãƒ¼:', error);
  }
}

function showTitleList() {
  // æ—¢å­˜ã®å‹•çš„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã¿ã‚’å‰Šé™¤ï¼ˆå›ºå®šã®å›³é‘‘ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯æ®‹ã™ï¼‰
  var existingDynamicOverlays = document.querySelectorAll('.overlay:not(#pokedexScreen):not(#gameOverlay)');
  existingDynamicOverlays.forEach(function(overlay) { overlay.remove(); });
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½: ç§°å·ä¸€è¦§ã«ç§»å‹•
  BROWSER_BACK.pushState('titlelist');
  
  var titleListScreen = document.createElement('div');
  titleListScreen.className = 'overlay';
  titleListScreen.style.display = 'flex';
  titleListScreen.style.zIndex = '1001';
  
  var titleListHTML = '';
  Object.keys(TITLE_DATA).forEach(function(id) {
    var titleId = parseInt(id);
    var titleData = TITLE_DATA[titleId];
    var unlocked = hasTitleUnlocked(titleId);
    var isSelected = userStats.selectedTitle === titleId;
    
    var displayTitle = titleData.title;
    var displayDesc = titleData.description;
    
    if (!unlocked && titleData.secret) {
      displayTitle = '???';
      displayDesc = '???ã‚’é”æˆã›ã‚ˆ';
    }
    
    var progress = '';
    if (!unlocked) {
      var current = 0;
      var pokedexStats = getPokedexStats();
      
      switch (titleData.condition_type) {
        case 'score_over':
          current = userStats.maxScore;
          break;
        case 'chain':
          current = userStats.maxChain;
          break;
        case 'games_played':
          current = userStats.gamesPlayed;
          break;
        case 'pokedex':
          current = pokedexStats.discovered;
          break;
        case 'cleared_blocks':
          current = userStats.totalCleared;
          break;
      }
      progress = ' (' + current + '/' + titleData.condition_value + ')';
    }
    
    titleListHTML += 
      '<div style="background: ' + (unlocked ? (isSelected ? 'linear-gradient(135deg, #ffeb3b, #ffc107)' : 'rgba(255,255,255,0.2)') : 'rgba(255,255,255,0.1)') + '; border-radius: 8px; padding: 12px; margin: 8px 0; border: 2px solid ' + (isSelected ? '#ffeb3b' : 'transparent') + ';">' +
        '<div style="display: flex; align-items: center; gap: 8px;">' +
          '<span style="font-size: 16px;">' + (unlocked ? (isSelected ? 'ğŸŒŸ' : 'âœ…') : 'â“') + '</span>' +
          '<div style="flex: 1; text-align: left;">' +
            '<div style="font-weight: bold; font-size: 14px;">' + displayTitle + progress + '</div>' +
            '<div style="font-size: 12px; opacity: 0.8;">' + displayDesc + '</div>' +
          '</div>' +
          (unlocked ? '<button onclick="selectTitle(' + titleId + ')" style="background: linear-gradient(135deg, #4facfe, #00f2fe); border: none; border-radius: 6px; padding: 4px 8px; color: white; font-size: 12px; cursor: pointer;">' + (isSelected ? 'è£…å‚™ä¸­' : 'è£…å‚™') + '</button>' : '') +
        '</div>' +
      '</div>';
  });
  
  titleListScreen.innerHTML = 
    '<div class="card" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">' +
      '<button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; color: #333;">Ã—</button>' +
      '<h3 style="margin: 16px 0;">ğŸ† ç§°å·ä¸€è¦§</h3>' +
      '<div style="margin: 20px 0;">' + titleListHTML + '</div>' +
      '<div class="row" style="margin-top: 20px;">' +
        '<button onclick="this.parentElement.parentElement.parentElement.remove(); showMyPage();" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">æˆ»ã‚‹</button>' +
      '</div>' +
    '</div>';
  
  document.body.appendChild(titleListScreen);
}

function selectTitle(titleId) {
  userStats.selectedTitle = titleId;
  saveUserStats();
  
  // ç§°å·ä¸€è¦§ã‚’å†è¡¨ç¤º
  showTitleList();
}

function showIconSelect() {
  // æ—¢å­˜ã®å‹•çš„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã¿ã‚’å‰Šé™¤ï¼ˆå›ºå®šã®å›³é‘‘ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯æ®‹ã™ï¼‰
  var existingDynamicOverlays = document.querySelectorAll('.overlay:not(#pokedexScreen):not(#gameOverlay)');
  existingDynamicOverlays.forEach(function(overlay) { overlay.remove(); });
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½: ã‚¢ã‚¤ã‚³ãƒ³é¸æŠã«ç§»å‹•
  BROWSER_BACK.pushState('iconselect');
  
  // ç”»åƒã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«è¡Œã†
  IMAGE_MANAGER.loadAllStageImages();
  
  var iconSelectScreen = document.createElement('div');
  iconSelectScreen.className = 'overlay';
  iconSelectScreen.style.display = 'flex';
  iconSelectScreen.style.zIndex = '1001';
  
  var pokedex = loadPokedex();
  var stageNames = ['æ˜¥ã®ã‚±ãƒ„', 'å¤ã®ã‚±ãƒ„', 'ç§‹ã®ã‚±ãƒ„', 'å†¬ã®ã‚±ãƒ„'];
  
  var iconListHTML = '';
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
  iconListHTML += 
    '<div onclick="selectIcon(0)" style="display: inline-block; margin: 8px; cursor: pointer; text-align: center; border: 3px solid ' + (userStats.selectedIcon === 0 ? '#ffeb3b' : 'transparent') + '; border-radius: 12px; padding: 8px;">' +
      '<div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #ccc, #999); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; margin: 0 auto 4px auto;">No Image</div>' +
      '<div style="font-size: 10px;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</div>' +
    '</div>';
  
  // ç™ºè¦‹æ¸ˆã¿ã¯ã‚€ã‚±ãƒ„
  for (var i = 1; i <= 24; i++) {
    var key = 'type_' + i;
    var entry = pokedex[key] || { count: 0, discovered: false };
    
    if (entry.discovered) {
      var stageIndex = Math.floor((i - 1) / 6);
      var data = POKEDEX_DATA[i];
      var isSelected = userStats.selectedIcon === i;
      
      var iconDisplay = getSafeImageDisplay(i, 'icon');
      
      iconListHTML += 
        '<div onclick="selectIcon(' + i + ')" style="display: inline-block; margin: 8px; cursor: pointer; text-align: center; border: 3px solid ' + (isSelected ? '#ffeb3b' : 'transparent') + '; border-radius: 12px; padding: 8px;">' +
          iconDisplay +
          '<div style="font-size: 10px; margin-top: 4px;">' + data.name + '</div>' +
        '</div>';
    }
  }
  
  iconSelectScreen.innerHTML = 
    '<div class="card" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">' +
      '<button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; color: #333;">Ã—</button>' +
      '<h3 style="margin: 16px 0;">ğŸ–¼ï¸ ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ</h3>' +
      '<p style="font-size: 12px; opacity: 0.8;">ç™ºè¦‹æ¸ˆã¿ã®ã¯ã‚€ã‚±ãƒ„ã‹ã‚‰é¸æŠã§ãã¾ã™</p>' +
      '<div style="margin: 20px 0; display: flex; flex-wrap: wrap; justify-content: center;">' + iconListHTML + '</div>' +
      '<div class="row" style="margin-top: 20px;">' +
        '<button onclick="this.parentElement.parentElement.parentElement.remove(); showMyPage();" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">æˆ»ã‚‹</button>' +
      '</div>' +
    '</div>';
  
  document.body.appendChild(iconSelectScreen);
}

function selectIcon(iconId) {
  userStats.selectedIcon = iconId;
  saveUserStats();
  
  // ã‚¢ã‚¤ã‚³ãƒ³é¸æŠç”»é¢ã‚’å†è¡¨ç¤º
  showIconSelect();
}

// ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚·ã‚§ã‚¢æ©Ÿèƒ½
function shareMyPage(platform) {
  console.log('ğŸ“¤ ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚·ã‚§ã‚¢:', platform);
  
  try {
    var bestScores = loadScores();
    var currentTitle = getSelectedTitleName();
    var bestScore = bestScores[0] ? bestScores[0].s : 0;
    
    // ã‚·ã‚§ã‚¢ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    var shareText = 
      'ç§°å·ã€Œ' + currentTitle + 'ã€\n' +
      'ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢: ' + bestScore + 'ç‚¹\n\n' +
      'ã¯ã‚€ã‚±ãƒ„ã‚’é›†ã‚ã¦ã·ã‚‹ã·ã‚‹æ¶ˆã™ã‚²ãƒ¼ãƒ  ğŸ®\n' +
      'ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆã€ãœã²éŠã‚“ã§ã¿ã¦ã­ï¼\n' +
      '#ãƒãƒ ã‚¹ã‚¿ãƒ¼ #ã¯ã‚€ãƒãƒ© #ã¯ã‚€ã‚±ãƒ„ã½ã‚ˆã½ã‚ˆ';
    
    var gameUrl = 'https://hamuchiranagaya.github.io/ketsu-poyo/';
    
    if (platform === 'x') {
      // X (Twitter) ã§ã‚·ã‚§ã‚¢
      var tweetText = encodeURIComponent(shareText);
      var tweetUrl = encodeURIComponent(gameUrl);
      var xUrl = 'https://twitter.com/intent/tweet?text=' + tweetText + '&url=' + tweetUrl;
      window.open(xUrl, '_blank');
      
    } else if (platform === 'line') {
      // LINE ã§ã‚·ã‚§ã‚¢
      var lineText = encodeURIComponent(shareText + '\n' + gameUrl);
      var lineUrl = 'https://social-plugins.line.me/lineit/share?url=' + encodeURIComponent(gameUrl) + '&text=' + lineText;
      window.open(lineUrl, '_blank');
    }
    
  } catch (error) {
    console.error('âŒ ã‚·ã‚§ã‚¢ã‚¨ãƒ©ãƒ¼:', error);
    alert('ã‚·ã‚§ã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
  }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆé–¢é€£
function loadUserStats() {
  try {
    if (typeof(Storage) !== "undefined" && localStorage) {
      var saved = localStorage.getItem('ham_poyo_user_stats');
      if (saved) {
        var loaded = JSON.parse(saved);
        userStats = Object.assign(userStats, loaded);
      }
    }
  } catch (error) {
    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
  }
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç§°å·ã‚’ç¢ºå®Ÿã«å–å¾—æ¸ˆã¿ã«ã™ã‚‹
  if (!hasTitleUnlocked(1)) {
    unlockTitle(1);
  }
}

function saveUserStats() {
  try {
    if (typeof(Storage) !== "undefined" && localStorage) {
      localStorage.setItem('ham_poyo_user_stats', JSON.stringify(userStats));
    }
  } catch (error) {
    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
  }
}

function updateStats(newScore, newChain, blocksCleared, isTimeMode) {
  console.log('çµ±è¨ˆæ›´æ–°é–‹å§‹ - ã‚¹ã‚³ã‚¢:', newScore, 'ãƒã‚§ã‚¤ãƒ³:', newChain);
  
  // çµ±è¨ˆæ›´æ–°
  if (newScore > userStats.maxScore) {
    userStats.maxScore = newScore;
  }
  if (newChain > userStats.maxChain) {
    userStats.maxChain = newChain;
  }
  userStats.gamesPlayed++;
  userStats.totalCleared += blocksCleared || 0;
  
  // åˆ¶é™æ™‚é–“ãƒ¢ãƒ¼ãƒ‰çµ±è¨ˆæ›´æ–°
  if (isTimeMode) {
    userStats.timeModePlayCount++;
    if (!gameOver) {
      userStats.timeModeClears++;
    }
  }
  
  // ç§°å·ãƒã‚§ãƒƒã‚¯
  checkAndUnlockTitles();
  saveUserStats();
}

function checkAndUnlockTitles() {
  console.log('ç§°å·ãƒã‚§ãƒƒã‚¯é–‹å§‹');
  
  try {
    var pokedexStats = getPokedexStats();
    
    Object.keys(TITLE_DATA).forEach(function(id) {
      var titleId = parseInt(id);
      var titleData = TITLE_DATA[titleId];
      
      if (!titleData) {
        console.log('ç§°å·ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', titleId);
        return;
      }
      
      if (hasTitleUnlocked(titleId)) return;
      
      var unlocked = false;
      
      try {
        switch (titleData.condition_type) {
          case 'default':
            unlocked = true;
            break;
          case 'score_over':
            unlocked = userStats.maxScore >= titleData.condition_value;
            break;
          case 'chain':
            unlocked = userStats.maxChain >= titleData.condition_value;
            break;
          case 'games_played':
            unlocked = userStats.gamesPlayed >= titleData.condition_value;
            break;
          case 'pokedex':
            unlocked = pokedexStats.discovered >= titleData.condition_value;
            break;
          case 'pokedex_complete':
            unlocked = pokedexStats.discovered >= 24;
            break;
          case 'cleared_blocks':
            unlocked = userStats.totalCleared >= titleData.condition_value;
            break;
          case 'time_mode_clear':
            unlocked = userStats.timeModeClears >= titleData.condition_value;
            break;
          case 'time_mode_play':
            unlocked = userStats.timeModePlayCount >= titleData.condition_value;
            break;
          case 'pokedex_unlock':
            // ç‰¹å®šã®ã¯ã‚€ã‚±ãƒ„ãŒç™ºè¦‹ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            var pokedex = loadPokedex();
            var entry = pokedex['type_' + titleData.condition_value];
            unlocked = entry && entry.discovered;
            break;
          default:
            console.log('ä¸æ˜ãªæ¡ä»¶ã‚¿ã‚¤ãƒ—:', titleData.condition_type);
            break;
        }
        
        if (unlocked) {
          unlockTitle(titleId);
        }
      } catch (conditionError) {
        console.log('ç§°å·æ¡ä»¶ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', titleId, conditionError);
      }
    });
  } catch (error) {
    console.error('ç§°å·ãƒã‚§ãƒƒã‚¯å…¨ä½“ã‚¨ãƒ©ãƒ¼:', error);
  }
}

function hasTitleUnlocked(titleId) {
  try {
    var unlockedTitles = JSON.parse(localStorage.getItem('ham_poyo_unlocked_titles') || '[]');
    return unlockedTitles.includes(titleId);
  } catch (error) {
    console.log('ç§°å·è§£æ”¾çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

function unlockTitle(titleId) {
  try {
    var unlockedTitles = JSON.parse(localStorage.getItem('ham_poyo_unlocked_titles') || '[]');
    if (!unlockedTitles.includes(titleId)) {
      unlockedTitles.push(titleId);
      localStorage.setItem('ham_poyo_unlocked_titles', JSON.stringify(unlockedTitles));
      
      // ç§°å·å–å¾—é€šçŸ¥
      var titleData = TITLE_DATA[titleId];
      if (titleData && titleId !== 1) { // åˆæœŸç§°å·ä»¥å¤–ã¯é€šçŸ¥
        setTimeout(function() {
          alert('ğŸ† æ–°ã—ã„ç§°å·ã‚’ç²å¾—ã—ã¾ã—ãŸï¼\n\nã€Œ' + titleData.title + 'ã€\n' + titleData.description);
        }, 1000);
      }
      
      console.log('ç§°å·è§£æ”¾:', titleId, titleData ? titleData.title : 'ä¸æ˜');
    }
  } catch (error) {
    console.error('ç§°å·è§£æ”¾ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
var keys = {};

window.addEventListener('keydown', function(e) {
  keys[e.code] = true;
  if (['ArrowUp', 'Space', 'KeyR'].includes(e.code)) {
    e.preventDefault();
  }
});

window.addEventListener('keyup', function(e) {
  if (keys[e.code]) {
    keys[e.code] = false;
    
    if (e.code === 'ArrowLeft') moveLeft();
    if (e.code === 'ArrowRight') moveRight();
    if (e.code === 'ArrowDown') softDrop();
    if (e.code === 'ArrowUp') rotate();
    if (e.code === 'Space') hardDrop();
    if (e.code === 'KeyR') restart();
  }
});

// ãƒªã‚µã‚¤ã‚º
window.addEventListener('resize', fit);

// åˆæœŸåŒ–
window.addEventListener('load', function() {
  console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
  BROWSER_BACK.init();
  
  // å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç”»åƒã‚’åˆæœŸåŒ–æ™‚ã«èª­ã¿è¾¼ã¿é–‹å§‹
  IMAGE_MANAGER.loadAllStageImages();
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã¨ãƒã‚±ãƒ‡ãƒƒã‚¯ã‚¹åˆæœŸåŒ–
  loadUserStats();
  updatePokedexCount();
  
  console.log('ã‚²ãƒ¼ãƒ æº–å‚™å®Œäº†');
});

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦ç™»éŒ²
window.selectStage = selectStage;
window.startGame = startGame;
window.showPokedex = showPokedex;
window.showMyPage = showMyPage;
window.shareToX = shareToX;
window.copyURL = copyURL;
window.simpleInstall = simpleInstall;
window.selectTitle = selectTitle;
window.selectIcon = selectIcon;
window.showTitleList = showTitleList;
window.showIconSelect = showIconSelect;
window.shareMyPage = shareMyPage;
window.closePokedex = closePokedex;
window.backToStart = backToStart;
window.restart = restart;
window.shareResult = shareResult;
window.moveLeft = moveLeft;
window.moveRight = moveRight;
window.softDrop = softDrop;
window.hardDrop = hardDrop;
window.rotate = rotate;
window.toggleTimeMode = toggleTimeMode;
</script>
</body>
</html>